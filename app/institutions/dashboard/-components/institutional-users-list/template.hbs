{{#if this.modelTaskInstance.isRunning}}
    <LoadingIndicator data-test-loading-indicator @dark={{true}} />
{{else}}
    <div local-class='filter-container'>
        <div local-class='orcid-switch'>
            <label for='switches-container' local-class='orcid-toggle-label'>{{t 'institutions.dashboard.users_list.has_orcid'}}</label>
            <label local-class='switch'>
                <input id='switches-container' type='checkbox' checked={{this.hasOrcid}} {{on 'change' (fn this.toggleOrcidFilter (not this.hasOrcid))}}>
                <span local-class='slider round'></span>
            </label>
        </div>
        <PowerSelect
            @options={{this.departments}}
            @searchEnabled={{true}}
            @selected={{this.department}}
            @triggerClass={{local-class 'select'}}
            @search={{perform this.searchDepartment}}
            @onChange={{this.onSelectChange}}
            as |department|
        >
            {{department}}
        </PowerSelect>
        <BasicDropdown
            @renderInPlace={{true}}
            @onClose={{this.onDropdownClose}}
            @preventScroll={{true}}
            @eventType='mousedown'
            local-class='dropdown'
            as |dd|
        >
            <button type='button' local-class='dropdown-trigger' {{on 'click' dd.actions.toggle}}>
                <FaIcon local-class='icon-columns' @icon='columns' />
                {{t 'institutions.dashboard.users_list.select_columns'}}
            </button>
            {{#if dd.isOpen}}
                <div local-class='dropdown-panel'>
                    <div local-class='dropdown-content'>
                        {{#each this.columns as |column|}}
                            <label>
                                <input
                                    type='checkbox'
                                    value={{column.key}}
                                    checked={{column.value}}
                                    {{on 'change' (fn this.toggleColumnSelection column.key)}}
                                />
                                {{column.label}}
                            </label>
                        {{/each}}
                    </div>
                    <div local-class='dropdown-actions'>
                        <button type='button' {{on 'click' dd.actions.close}}>
                            {{t 'general.cancel'}}
                        </button>
                        <button type='button' local-class='apply-button' {{on 'click' this.applyColumnSelection}}>
                            {{t 'general.apply'}}
                        </button>
                    </div>
                </div>
            {{/if}}
        </BasicDropdown>
    </div>
    <PaginatedList::HasMany
        local-class='table'
        @isTable={{true}}
        @model={{@institution}}
        @usePlaceholders={{false}}
        @relationshipName='userMetrics'
        @bindReload={{this.reloadUserList}}
        @query={{this.queryUsers}}
        as |list|
    >
        <list.header local-class='header'>
            {{#let (component 'sort-arrow'
                class=(local-class 'sort-arrow')
                sortAction=this.sortInstitutionalUsers
                sort=this.sort
                ) as |SortArrow|}}
                <tr>
                    {{#each this.columns as |column|}}
                        {{#if (includes column.key this.selectedColumns)}}
                            <th data-test-header='{{column.key}}'>
                                <div local-class='header-content'>
                                    <span local-class='header-text'>{{column.label}}</span>
                                    {{#if column.sort_key}}
                                        <span local-class='sort-arrow-container'>
                                            <SortArrow @sortBy='{{column.sort_key}}' />
                                        </span>
                                    {{/if}}
                                </div>
                            </th>
                        {{/if}}
                    {{/each}}
                </tr>
            {{/let}}
        </list.header>
        <list.item local-class='item' as |institutionalUser|>
            {{#each this.columns as |column|}}
                {{#if (includes column.key this.selectedColumns)}}
                    <td data-test-item={{column.key}}>
                        {{#if (eq column.type 'user_name')}}
                            <OsfLink @href={{concat '/' institutionalUser.userGuid '/'}}>
                                {{institutionalUser.userName}}
                            </OsfLink>
                        {{else if (eq column.type 'osf_link')}}
                            <OsfLink @href={{concat '/' institutionalUser.userGuid '/'}}>
                                {{institutionalUser.userGuid}}
                            </OsfLink>
                        {{else if (eq column.type 'date_by_month')}}
                            {{moment-format (get institutionalUser column.key) 'MM/YYYY'}}
                        {{else}}
                            {{get institutionalUser column.key}}
                        {{/if}}
                    </td>
                {{/if}}
            {{/each}}
        </list.item>
        <list.empty local-class='empty'>
            {{t 'institutions.dashboard.users_list.empty'}}
        </list.empty>
    </PaginatedList::HasMany>
{{/if}}
