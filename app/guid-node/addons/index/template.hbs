{{page-title (t 'addons.heading')}}

<div local-class='addon-page-wrapper'>
    <AddonsService::Manager
        @node={{this.model}}
        as |manager|
    >
        <h3 local-class='page-heading'>{{manager.headingText}}</h3>
        {{#if manager.selectedProvider}}
            {{#let manager.selectedProvider as |provider|}}
                <div
                    data-test-addon={{provider.provider.name}}
                    data-analytics-scope='Addon - {{provider.provider.name}}'
                >
                    <div local-class='back-button'>
                        <Button
                            data-test-addon-back-button
                            data-analytics-name='Back'
                            @layout='fake-link'
                            {{on 'click' manager.cancelSetup}}
                        >
                            {{t 'general.back'}}
                        </Button>
                    </div>
                    {{#if (eq manager.pageMode 'terms')}}
                        <Button
                            data-test-addon-accept-terms-button
                            data-analytics-name='Accept Terms'
                            {{on 'click' manager.acceptTerms}}
                            disabled={{provider.getAuthorizedStorageAccounts.isRunning}}
                        >
                            {{#if provider.getAuthorizedStorageAccounts.isRunning}}
                                {{t 'addons.terms.accepting'}}
                            {{else}}
                                {{t 'general.confirm'}}
                            {{/if}}
                        </Button>
                    {{else if (eq manager.pageMode 'newOrExistingAccount')}}
                        <Button
                            data-test-addon-existing-account-button
                            data-analytics-name='Choose existing account'
                            {{on 'click' manager.chooseExistingAccount}}
                        >
                            {{t 'addons.accountSelect.existing-account'}}
                        </Button>
                        <Button
                            data-test-addon-new-account-button
                            data-analytics-name='Create new account'
                            {{on 'click' manager.createNewAccount}}
                        >
                            {{t 'addons.accountSelect.new-account'}}
                        </Button>
                    {{else if (eq manager.pageMode 'accountSelect')}}
                        <fieldset>
                            {{#each provider.authorizedStorageAccounts as |account| }}
                                <div local-class='account-select'>
                                    <label>
                                        <Input
                                            name='account-select'
                                            @value={{account.id}}
                                            @type='radio'
                                            @checked={{eq manager.selectedAccount.id account.id}}
                                            {{on 'change' (fn manager.selectAccount account)}}
                                        />
                                        {{account.externalUserDisplayName}}
                                    </label>
                                </div>
                            {{else}}
                                {{t 'addons.accountSelect.no-accounts'}}
                            {{/each}}
                        </fieldset>
                        <Button
                            data-test-addon-authorize-button
                            data-analytics-name='Authorize'
                            disabled={{not manager.selectedAccount.id}}
                            {{on 'click' manager.authorizeSelectedAccount}}
                        >
                            {{t 'general.authorize'}}
                        </Button>
                    {{else if (eq manager.pageMode 'accountCreate')}}
                        {{!-- Check selectedProvider's auth type (credentials/keys/token/etc) --}}
                        <form>
                            <label local-class='auth-text-input-label'>
                                {{t 'addons.accountCreate.username-label'}}
                                <Input
                                    autocomplete='username'
                                    @type='text'
                                    @placeholder={{t 'addons.accountCreate.username-placeholder'}}
                                    @value={{manager.username}}
                                />
                            </label>
                            <label local-class='auth-text-input-label'>
                                {{t 'addons.accountCreate.password-label'}}
                                <Input
                                    autocomplete='current-password'
                                    @type='password'
                                    @placeholder={{t 'addons.accountCreate.password-placeholder'}}
                                    @value={{manager.password}}
                                />
                            </label>
                            <Button
                                data-test-addon-connect-account-button
                                data-analytics-name='Connect Account'
                                disabled={{manager.connectAccount.isRunning}}
                                {{on 'click' (perform manager.connectAccount)}}
                            >
                                {{t 'general.authorize'}}
                            </Button>
                        </form>
                        {{!-- Link for OAuth --}}
                        {{!-- TODO: need clientId, callback and other fields to actually make this work --}}
                        <div>
                            {{t 'addons.accountCreate.oauth-description' providerName=provider.provider.name}}
                            <a
                                data-test-addon-oauth-link
                                data-analytics-name='OAuth'
                                href={{provider.oauthUrl}}
                                target='_blank'
                                rel='noopener noreferrer'
                            >
                                {{t 'addons.accountCreate.oauth-link' providerName=provider.provider.name}}
                            </a>
                        </div>
                    {{else if (eq manager.pageMode 'confirm')}}
                        {{t 'addons.confirm.verify'}}
                        {{manager.selectedAccount.externalUserDisplayName}}
                        <div>
                            <Button
                                data-test-addon-confirm-setup-button
                                data-analytics-name='Confirm Setup'
                                disabled={{manager.confirmAccountSetup.isRunning}}
                                {{on 'click' (perform manager.confirmAccountSetup manager.selectedAccount)}}
                            >
                                {{if manager.confirmAccountSetup.isRunning (t 'addons.confirm.authorizing') (t 'general.confirm')}}
                            </Button>
                        </div>
                    {{else if (eq manager.pageMode 'configure')}}
                        <Button
                            data-test-addon-save-button
                            data-analytics-name='Save'
                            {{on 'click' (fn manager.save provider)}}
                        >
                            {{t 'general.save'}}
                        </Button>
                    {{/if}}
                </div>
            {{/let}}
        {{else}}
            {{t 'addons.list.sync-details-1'}}
            {{t 'addons.list.sync-details-2'}}
            <div local-class='addons-list-wrapper {{if this.isMobile 'mobile'}}'>
                <div
                    data-analytics-scope='Addon List Filter'
                    local-class='filter-wrapper {{if this.isMobile 'mobile'}}'
                >
                    <Input
                        data-test-addon-list-filter-input
                        placeholder='{{t 'addons.list.filter-placeholder'}}'
                        @type='text'
                        @value={{manager.filterText}}
                    />
                    {{#each manager.possibleFilterTypes as |type|}}
                        <Button
                            data-test-addon-list-filter={{type}}
                            data-analytics-name={{t (concat 'addons.list.filter.' type)}}
                            local-class='filter-button {{if (eq manager.activeFilterType type) 'active'}}'
                            @layout='fake-link'
                            {{on 'click' (fn manager.filterByAddonType type)}}
                        >
                            {{t (concat 'addons.list.filter.' type)}}
                        </Button>
                    {{/each}}
                </div>
                <div local-class='addon-cards-wrapper'>
                    {{#if manager.currentListIsLoading}}
                        <LoadingIndicator @dark={{true}} />
                    {{else}}
                        {{#each manager.filteredAddonProviders as |addon|}}
                            <AddonCard @addon={{addon}} @manager={{manager}} />
                        {{else}}
                            {{t 'addons.list.no-results'}}
                        {{/each}}
                    {{/if}}
                </div>
            </div>
        {{/if}}
    </AddonsService::Manager>
</div>